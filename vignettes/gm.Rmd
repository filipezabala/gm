---
title: "Complete Guide to gm"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Complete Guide to gm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  
  # To prevent CRAN from building this vignette:
  # 
  # 1. Add `BUILD_VIGNETTE=TRUE` in .Renviron before calling
  # `devtools::build()` or `R CMD build`, to build this vignette locally.
  # 
  # 2. Remove `BUILD_VIGNETTE=TRUE` before calling `R CMD check --as-cran`.
  eval = Sys.getenv("BUILD_VIGNETTE") == "TRUE"
)
```


```{r message = FALSE}
library(gm)
```

There are two interpretations of the package name *gm*:

1. grammar of music
2. generate music

They correspond to two functionalities of the package:

1. a language for music representation
2. generation of music scores and audio files

Let's start with a quick example.


## Example

```{r}
music <- 
  Music() +
  Meter(4, 4) +
  Line(c("C5", "D5", "E5", "F5"))
  
show(music)
```

Let's go through the code line by line:

1. `music <-` defines a variable.
2. `Music()` initializes a `Music` object.
3. `+ Meter(4, 4)` adds a 4/4 time signature.
4. `+ Line(c("C5", "D5", "E5", "F5"))` adds four notes.
5. `show(music)` generates the music.

We don’t have to stop here. We can add more components. For example, add a tempo:

```{r}
music <- music + Tempo(180)
show(music)
```

Add an articulation:

```{r}
music <- music + Articulation(">", 1)
show(music)
```

Add a pedal:

```{r}
music <- music + Pedal(1, 4)
show(music)
```

There are still many other components we can add. Before we dive in, let's see how to install and configure gm.


## Installation

Install gm:

```r
install.packages("gm")
```

Install [MuseScore](https://musescore.org/). MuseScore is open source
and free notation software. Internally, gm uses MuseScore to generate music. 


## Configuration

You don’t need to configure anything if MuseScore is installed to a [default path](https://musescore.org/en/handbook/4/revert-factory-settings).

Otherwise, please specify the path to the MuseScore executable file in .Renviron file:

1. Open .Renviron file.
2. Add environment variable `MUSESCORE_PATH=<path to MuseScore>`.
3. Restart R session.

For example, the environment variable is like

- `MUSESCORE_PATH=C:/Program Files/MuseScore 4/bin/MuseScore4.exe` in Windows, and
- `MUSESCORE_PATH=/Applications/MuseScore\ 4.app/Contents/MacOS/mscore` in macOS.


## Music

At the highest level, gm uses `Music` objects to represent music.

As shown in the *Quick Example* section, the workflow for creating music is usually like this:

1. Initialize a `Music` object with `Music()`.
2. Add components to it with `+`.
3. Display the music with `show()`.

A `Music` object is represented as a list of data frames. Each data frame represents some type of components of the music. To examine a `Music` object's representation, simply print it. For example, below is the representation of the `Music` object created in the *Quick Example* section:

```{r}
music <- 
  Music() +
  Meter(4, 4) +
  Line(c("C5", "D5", "E5", "F5"))
  
show(music)
```

```{r}
music
```

We will explore every type of components as we proceed.


## Musical Lines

Musical lines are the most basic units of music in gm. You can create a musical line with `Line()`.

### Pitches and Durations

You can specify the pitches and durations of a musical line with arguments `pitches` and `durations`. For example:

```{r}
line <- Line(
  pitches = c("C5", "D5", "E5", "F5"),
  durations = c(0.5, 1, 1.5, 2)
)

music <- Music() + Meter(5, 4) + line
show(music)
```

We will talk more about them later.

### Musical Line Insertion

You can insert a musical line at positions other than the first beat of the first bar with arguments `bar` and `offset`. For example:

```{r}
line <- Line(c("C5", "D5", "E5"), bar = 2, offset = 1)
music <- Music() + Meter(4, 4) + line
show(music)
```

The musical line is inserted at the second beat of the second bar.

### Multiple Musical Lines

Music can contain more than one musical line. For example:

```{r}
line_1 <- Line(c("C5", "D5", "E5", "F5"))
line_2 <- Line(c("E4", "G4"), 2)
line_3 <- Line("C4", 4)
music <- Music() + Meter(4, 4) + line_1 + line_2 + line_3
show(music)
```

You can assign a name to a musical line with argument `name`. For example:

```{r}
line_1 <- Line(c("C5", "D5", "E5", "F5"), name = "a")
line_2 <- Line(c("E4", "G4"), 2, name = "b")
line_3 <- Line("C4", 4, name = "c")
music <- Music() + Meter(4, 4) + line_1 + line_2 + line_3
show(music)
```

By default, a musical line is added to the end. You can change it with argument `to` and `after`. For example:

```{r}
line_1 <- Line(c("C5", "D5", "E5", "F5"), name = "a")
line_2 <- Line(c("E4", "G4"), 2, name = "b")
line_3 <- Line("C4", 4, name = "c", to = "a", after = FALSE)
music <- Music() + Meter(4, 4) + line_1 + line_2 + line_3
show(music)
```

Now the third musical line is added to the beginning.

### Musical Line Types

There are four types of musical lines in gm:

1. part
2. staff
3. voice
4. segment

You specify the type with argument `as`. For example, the following music has two parts:

```{r}
music <- 
  Music() +
  Meter(4, 4) +
  Line(c("C5", "D5", "E5", "F5")) +
  Line(c("C4", "G4"), 2, as = "part")

show(music)
```

Part is the default type, so you can also remove `as = "part"`.

This music has two staffs:

```{r}
music <- 
  Music() +
  Meter(4, 4) +
  Line(c("C5", "D5", "E5", "F5")) +
  Line(c("C4", "G4"), 2, as = "staff")

show(music)
```

This music has two voices:

```{r}
music <- 
  Music() +
  Meter(4, 4) +
  Line(c("C5", "D5", "E5", "F5")) +
  Line(c("C4", "G4"), 2, as = "voice")

show(music)
```

And this music has two segments:

```{r}
music <- 
  Music() +
  Meter(4, 4) +
  Line(c("C5", "D5", "E5", "F5")) +
  Line(c("C4", "G4"), 2, as = "segment", bar = 2)

show(music)
```

Segments are used to insert musical lines into other musical lines.

### Musical Line Representation

The `$lines` data frame of a `Music` object contains the information about all musical lines. For example:

```{r}
line_1 <- Line(c("C5", "D5", "E5", "F5"), name = "a")
line_2 <- Line(c("E4", "G4"), 2, name = "b", as = "voice")
line_3 <- Line("C4", 2, name = "c", as = "staff", offset = 2)
music <- Music() + Meter(4, 4) + line_1 + line_2 + line_3
show(music)
```

```{r}
music$lines
```

We can see from the data frame that this music has one part, and this part has two staffs. The first staff has two voices. The second staff is inserted at the second beat.
